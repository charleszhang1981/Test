# 单机模式（修为对战电脑）设计方案

## 1. 目标与范围

- 将现有“单机训练”升级为“单机模式（修为对战电脑）”。
- 玩法为玩家 vs 电脑，双方都可发送垃圾行。
- 仅注册用户记录修为进度与胜场；匿名用户可玩但不升级。
- 难度共 8 级，按修为逐级推进，失败不降级。

非目标（本期不做）：
- 不接入大模型或联网 AI。
- 不做每局详细战报与复盘系统。
- 不保留旧“纯训练”模式。

## 2. 核心规则

- 胜负条件：先爆顶者输。
- 垃圾行规则：单次消除 2/3/4 行，向对手发送 2/3/4 行；单消不发送。
- 修为等级：
  1. 炼气期
  2. 筑基期
  3. 结丹期
  4. 元婴期
  5. 化神期
  6. 炼虚期
  7. 合体期
  8. 大乘期
- 升级规则：
  - 注册用户胜利：等级 +1（上限 8）；
  - 失败：不降级；
  - 大乘期胜利：显示“您已经天下无敌了”，不再升级。

## 3. 难度系统（非线性）

采用“双轨加压”：
- 轨道 A：电脑更强（更快、更稳定、更容易多消行）。
- 轨道 B：玩家环境更难（方块自动下落更快）。

> 目标：从结丹期开始，体感明显变难。

| 等级 | 名称 | 玩家下落 `gravityMs` | 电脑行动 `aiTickMs` | 电脑有效清行 `aiLineChance` | 多消偏置 `aiMultiLineBias` | 电脑失误 `aiMistakeChance` |
| --- | --- | ---: | ---: | ---: | ---: | ---: |
| 1 | 炼气期 | 900 | 900 | 0.35 | 0.10 | 0.22 |
| 2 | 筑基期 | 820 | 820 | 0.42 | 0.16 | 0.18 |
| 3 | 结丹期 | 720 | 730 | 0.52 | 0.26 | 0.12 |
| 4 | 元婴期 | 620 | 660 | 0.60 | 0.34 | 0.09 |
| 5 | 化神期 | 540 | 600 | 0.68 | 0.42 | 0.07 |
| 6 | 炼虚期 | 470 | 550 | 0.74 | 0.50 | 0.05 |
| 7 | 合体期 | 410 | 500 | 0.80 | 0.58 | 0.04 |
| 8 | 大乘期 | 360 | 450 | 0.86 | 0.66 | 0.03 |

## 4. 持久化与权限

### 4.1 注册用户

- 进度写入 Supabase（`player_stats`）：
  - `single_realm_level`（1-8）
  - `single_ai_wins`
- 结算后由后端返回最新等级，前端以返回值为准。

### 4.2 匿名用户

- 可进入单机模式，但固定炼气期。
- 不写入修为与胜场。
- UI 明示提示：想升级需注册账号。

## 5. 页面与交互

- 首页入口文案：
  - “单机训练”改为“单机模式”。
- 单机模式界面：
  - 左右双棋盘：玩家 / 电脑。
  - 显示当前修为、双方分数、待处理垃圾。
  - 显示规则提示（按键、垃圾行、胜负条件）。
- 对局结束提示：
  - 升级成功：显示突破提示；
  - 失败：显示“修为不变”；
  - 大乘胜利：显示“您已经天下无敌了”。

## 6. 数据库与 SQL 变更（MVP）

### 6.1 `player_stats` 增列

- `single_realm_level smallint not null default 1 check (single_realm_level between 1 and 8)`
- `single_ai_wins integer not null default 0 check (single_ai_wins >= 0)`

### 6.2 新增 RPC

函数建议：`submit_single_ai_result(p_is_win boolean)`，规则：
- 若匿名：返回当前统计，不更新；
- 若注册且胜利：
  - `single_ai_wins = single_ai_wins + 1`
  - `single_realm_level = least(single_realm_level + 1, 8)`
- 若注册且失败：不改等级与胜场。

### 6.3 单机排行榜视图调整

单机榜排序改为：
1. `single_realm_level desc`
2. `single_ai_wins desc`
3. `updated_at asc`
4. `display_name asc`

## 7. 前端实现策略（MVP）

- 用现有单机状态机扩展为“玩家 + 简化电脑”双端运行。
- 电脑不做精细逐步落子动画，按参数驱动“行动-清行-送垃圾”。
- 玩家操作键维持不变：
  - `A/D` 左右
  - `W` 旋转
  - `S` 加速下落

## 8. 异常与回退

- 读进度失败：回退炼气期并提示，不阻断游戏。
- 写进度失败：保留本局结果提示，单独提示“进度保存失败”。
- 运行异常：立即停止本局，允许快速重开。

## 9. 验收标准

- 注册用户可从炼气连续升至大乘，刷新后进度不丢失。
- 匿名用户始终炼气期，且有“注册可升级”提示。
- 结丹期开始体感明显更难（玩家下落更快 + 电脑更强）。
- 垃圾行规则（2/3/4 消对应 2/3/4 垃圾）稳定生效。
- 单机排行榜按“修为 > 胜场”排序正确。

